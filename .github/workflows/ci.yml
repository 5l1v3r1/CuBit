name: CuBit CI

on: [push]

jobs:

    build:
        name: Build
        runs-on: ubuntu-latest
        container: jonfandrew/cubit-gnat:latest
        steps:

            - name: Check out repo
              uses: actions/checkout@v2

            - name: Build CuBit
              id: build_id
              run: make cubit_kernel

            - name: Build CuBit ISO
              run: make iso
           
            - name: Upload iso
              uses: actions/upload-artifact@v2
              with:
                name: cubit_iso
                path: cubit_kernel.iso

            - name: Build Documents
              run: make docs

            - name: Upload gnatdoc
              uses: actions/upload-artifact@v2
              with:
                name: gnatdoc
                path: build/gnatdoc

            - name: Build Cross-Referenced Code HTML
              run: make html

            - name: Upload html
              uses: actions/upload-artifact@v2
              with:
                name: gnathtml
                path: build/gnathtml

    deploy:
        name: Deploy Documentation to gh-pages branch
        runs-on: ubuntu-latest
        needs: build
        steps:
            - name: Re-checkout for pages deployment
              uses: actions/checkout@v2
              with:
                persist-credentials: false

            - name: Get gnatdoc artifacts
              uses: actions/download-artifact@v2
              with:
                name: gnatdoc

            - name: Get gnathtml artifacts
              uses: actions/download-artifact@v2
              with:
                name: gnathtml

            - name: Deploy GNATdoc Pages
              uses: JamesIves/github-pages-deploy-action@releases/v3
              with:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                BRANCH: gh-pages # deploy to this branch
                FOLDER: gnatdoc

            - name: Deploy HTML Source
              uses: JamesIves/github-pages-deploy-action@releases/v3
              with:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                BRANCH: gh-pages
                FOLDER: gnathtml
